app-id: org.freedesktop.Sdk.Extension.ldc
branch: '20.08'
runtime: org.freedesktop.Sdk
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
build-extension: true
separate-locales: false
appstream-compose: false
build-options:
  prefix: /usr/lib/sdk/ldc
cleanup:
  - /bootstrap
modules:

  - name: ldc-bootstrap
    build-options:
      prefix: /usr/lib/sdk/ldc/bootstrap
      prepend-path: /usr/lib/sdk/ldc/bootstrap/bin
    buildsystem: cmake-ninja
    config-opts:
      - -DLLVM_ROOT_DIR=/usr/lib/sdk/ldc/bootstrap
    builddir: true
    sources:
      - type: archive
        url: "https://github.com/ldc-developers/ldc/releases/download/v0.17.6/ldc-0.17.6-src.tar.gz"
        sha256: 868b8c07ab697306ea65f0006fc2b6b96db4df226e82f8f11cafbed6fa9ac561
    modules:

      #FIXME: remove once https://github.com/ldc-developers/ldc/issues/3109 is resolved
      - name: llvm-6
        build-options:
          prefix: /usr/lib/sdk/ldc/bootstrap
          ldflags: -Wl,--no-keep-memory -Wl,--reduce-memory-overheads
          cflags: -O2 -g0
          cflags-override: true
          cxxflags: -O2 -g0
          cxxflags-override: true
          strip: true
          arch:
            x86_64:
              config-opts:
                - -DLLVM_TARGETS_TO_BUILD=X86
            aarch64:
              config-opts:
                - -DLLVM_TARGETS_TO_BUILD=AArch64
            arm:
              config-opts:
                - -DLLVM_TARGETS_TO_BUILD=ARM
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=MinSizeRel
        builddir: true
        sources:
          - type: archive
            url: "https://releases.llvm.org/6.0.1/llvm-6.0.1.src.tar.xz"
            sha256: b6d6c324f9c71494c0ccaf3dac1f16236d970002b42bb24a6c9e1634f7d0f4e2

      - name: libconfig
        build-options:
          prefix: /usr/lib/sdk/ldc/bootstrap
        config-opts:
          - --enable-static
          - --disable-shared
        sources:
          - type: archive
            url: "https://hyperrealm.github.io/libconfig/dist/libconfig-1.7.2.tar.gz"
            sha256: 7c3c7a9c73ff3302084386e96f903eb62ce06953bb1666235fac74363a16fad9

  - name: lld
    buildsystem: cmake-ninja
    builddir: true
    post-install:
      - mv -v ${FLATPAK_DEST}/lib/$(gcc -print-multiarch)/* ${FLATPAK_DEST}/lib/
      - rmdir ${FLATPAK_DEST}/lib/$(gcc -print-multiarch)
    sources:
      - type: archive
        url: https://github.com/llvm/llvm-project/releases/download/llvmorg-10.0.1/lld-10.0.1.src.tar.xz
        sha256: 591449e0aa623a6318d5ce2371860401653c48bb540982ccdd933992cb88df7a
    cleanup:
      - "*"

  - name: ldc-cycle
    build-options:
      prefix: /usr/lib/sdk/ldc/cycle
      append-path: /usr/lib/sdk/ldc/bootstrap/bin
      ldflags: &ldc_ldflags -L/usr/lib/sdk/ldc/lib
    buildsystem: cmake-ninja
    sources: &ldc_sources
      - type: archive
        url: https://github.com/ldc-developers/ldc/releases/download/v1.22.0/ldc-1.22.0-src.tar.gz
        sha256: 866becac61fb225b0d55847fb5f206ff042d6a3ff63b671a474aa8b6a93d8988
      - type: shell
        commands:
          - sed "s/-lLLVMSymbolize/$(llvm-config --libs Symbolize)/g" -i CMakeLists.txt
    cleanup:
      - "*"

  - name: ldc-source
    build-options:
      prepend-path: /usr/lib/sdk/ldc/cycle/bin
      ldflags: *ldc_ldflags
    buildsystem: cmake-ninja
    sources: *ldc_sources

  - name: dtools
    buildsystem: simple
    build-options:
      prepend-path: /usr/lib/sdk/ldc/bin
    build-commands:
      - ldmd2 -O -release ddemangle.d -ofddemangle
      - ldmd2 -O -release DustMite/dustmite.d DustMite/splitter.d -ofdustmite
      - ldmd2 -O -release rdmd.d -ofrdmd
      - install -Dsm0755 ddemangle dustmite rdmd /usr/lib/sdk/ldc/bin/
    sources:
      - type: archive
        url: https://github.com/dlang/tools/archive/v2.092.1.tar.gz
        sha256: 8db4d21c6348fc25143d532e56f345198a384cce85c08979aca2476211e15113

  - name: dub
    buildsystem: simple
    build-options:
      prepend-path: /usr/lib/sdk/ldc/bin
    build-commands:
      - DMD=ldmd2 GITVER="v1.21.0" ./build.d
      - install -s bin/dub /usr/lib/sdk/ldc/bin/
    sources:
      - type: archive
        url: https://github.com/dlang/dub/archive/v1.21.0.zip
        sha256: 9fe7f1c4f0fafa626718b1e7ad4a87bd6ad09117f63b4dcf995bb78df8c20189

  - name: scripts
    buildsystem: simple
    build-commands:
      - 'cp {install,enable}.sh /usr/lib/sdk/ldc'
    sources:
      - type: script
        commands:
          - 'export PATH="$PATH:/usr/lib/sdk/ldc/bin"'
          - 'export LIBRARY_PATH="$LIBRARY_PATH:/usr/lib/sdk/ldc/lib"'
          - 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/usr/lib/sdk/ldc/lib"'
        dest-filename: enable.sh
      - type: script
        commands:
          - 'mkdir -p ${FLATPAK_DEST}/lib'
          - 'cp -r /usr/lib/sdk/ldc/lib/lib{druntime,phobos2}-ldc-shared.so* /usr/lib/sdk/ldc/lib/libldc-jit.so* ${FLATPAK_DEST}/lib/'
        dest-filename: install.sh

  - name: appdata
    buildsystem: simple
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/share/metainfo
      - cp ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo
      - appstream-compose --basename=${FLATPAK_ID} --prefix=${FLATPAK_DEST} --origin=flatpak ${FLATPAK_ID}
    sources:
      - type: file
        path: org.freedesktop.Sdk.Extension.ldc.metainfo.xml
