app-id: org.freedesktop.Sdk.Extension.ldc
branch: '22.08'
runtime: org.freedesktop.Sdk
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
build-extension: true
separate-locales: false
appstream-compose: false
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm14
build-options:
  prefix: /usr/lib/sdk/ldc
  prepend-path: /usr/lib/sdk/llvm14/bin
  prepend-ld-library-path: /usr/lib/sdk/llvm14/lib
cleanup:
  - /bootstrap
modules:

  - name: ldc-bootstrap
    buildsystem: simple
    build-commands:
      - mkdir -p /usr/lib/sdk/ldc/bootstrap
      - cp -av * /usr/lib/sdk/ldc/bootstrap/
    cleanup:
      - '*'
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://github.com/ldc-developers/ldc/releases/download/v1.32.0/ldc2-1.32.0-linux-x86_64.tar.xz
        sha256: 5a7b22cfa31568504f3f36ed0f474415c2760bf71d478aca0896a6857c00ba5a
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ldc-developers/ldc/releases/latest
          version-query: .tag_name | sub("^[vV]"; "")
          url-query: >-
            .assets | map(select(.name=="ldc2-\($version)-linux-x86_64.tar.xz")) |
            first | .browser_download_url

      - type: archive
        only-arches:
          - aarch64
        url: https://github.com/ldc-developers/ldc/releases/download/v1.32.0/ldc2-1.32.0-linux-aarch64.tar.xz
        sha256: a1c87b2bbf73b231ec5269669763da55426d6a4f1c3e75a2b8bc990257763482
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ldc-developers/ldc/releases/latest
          version-query: .tag_name | sub("^[vV]"; "")
          url-query: >-
            .assets | map(select(.name=="ldc2-\($version)-linux-aarch64.tar.xz"))
            | first | .browser_download_url

  - name: ldc-cycle
    build-options:
      prefix: /usr/lib/sdk/ldc/cycle
      append-path: /usr/lib/sdk/ldc/bootstrap/bin
    buildsystem: cmake-ninja
    config-opts: &ldc_config_opts
      - -DLDC_WITH_LLD:BOOL=OFF
    sources:
      - &ldc-source
        type: archive
        url: https://github.com/ldc-developers/ldc/releases/download/v1.32.0/ldc-1.32.0-src.tar.gz
        sha256: c4ee0bf91b416dd5641353d9b267b6a48600c499c782beb112d2e460e329beac
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ldc-developers/ldc/releases/latest
          tag-query: .tag_name
          version-query: $tag | sub("^[vV]"; "")
          url-query: >-
            .assets | map(select(.name=="ldc-\($version)-src.tar.gz")) | first | .browser_download_url
          is-main-source: true
    cleanup:
      - '*'

  - name: ldc
    build-options:
      prepend-path: /usr/lib/sdk/ldc/cycle/bin
    buildsystem: cmake-ninja
    config-opts: *ldc_config_opts
    sources:
      - *ldc-source

  - name: dtools
    buildsystem: simple
    build-options:
      prepend-path: /usr/lib/sdk/ldc/bin
    build-commands:
      - ldmd2 -O -release ddemangle.d -ofddemangle
      - ldmd2 -O -release DustMite/dustmite.d DustMite/splitter.d DustMite/polyhash.d
        -ofdustmite
      - ldmd2 -O -release rdmd.d -ofrdmd
      - install -Dsm0755 ddemangle dustmite rdmd /usr/lib/sdk/ldc/bin/
    sources:
      - type: git
        url: https://github.com/dlang/tools.git
        tag: v2.102.2
        commit: 3e46fadc8bf1755603d8e54b04b48d6795f3f0a7
        x-checker-data:
          type: git
          tag-pattern: ^v([\d\.]+)$

  - name: dub
    buildsystem: simple
    build-options:
      prepend-path: /usr/lib/sdk/ldc/bin
    build-commands:
      - DMD=ldmd2 ./build.d
      - install -s bin/dub /usr/lib/sdk/ldc/bin/
    sources:
      - type: git
        url: https://github.com/dlang/dub.git
        tag: v1.31.1
        commit: cedf3155fa9201db8996bcff12064b813df6ac69
        x-checker-data:
          type: json
          url: https://api.github.com/repos/dlang/dub/releases/latest
          tag-query: .tag_name
          version-query: $tag | sub("^[vV]"; "")

  - name: scripts
    buildsystem: simple
    build-commands:
      - cp {install,enable}.sh /usr/lib/sdk/ldc
    sources:
      - type: script
        commands:
          - export PATH="$PATH:/usr/lib/sdk/ldc/bin"
          - export LIBRARY_PATH="$LIBRARY_PATH:/usr/lib/sdk/ldc/lib"
          - export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/usr/lib/sdk/ldc/lib"
        dest-filename: enable.sh
      - type: script
        commands:
          - mkdir -p ${FLATPAK_DEST}/lib
          - cp -r /usr/lib/sdk/ldc/lib/lib{druntime,phobos2}-ldc-shared.so* /usr/lib/sdk/ldc/lib/libldc-jit.so*
            ${FLATPAK_DEST}/lib/
        dest-filename: install.sh

  - name: appdata
    buildsystem: simple
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/share/metainfo
      - cp ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo
      - appstream-compose --basename=${FLATPAK_ID} --prefix=${FLATPAK_DEST} --origin=flatpak
        ${FLATPAK_ID}
    sources:
      - type: file
        path: org.freedesktop.Sdk.Extension.ldc.metainfo.xml
